# System Patterns and Architecture

Этот документ описывает архитектурные решения и паттерны, принятые в проекте.

## Архитектура

Проект построен на основе микросервисного подхода, где основное приложение и сервер для real-time коммуникаций разделены.

1.  **Next.js Приложение**:
    - **Фреймворк**: Next.js 15 с **App Router**.
    - **Рендеринг**: Активное использование **серверных компонентов** для выборки данных и статического рендеринга, и **клиентских компонентов** для интерактивности (чаты, формы).
    - **API**: API-маршруты реализованы через **Route Handlers** в `src/app/api/`.

2.  **Выделенный Socket.IO Сервер**:
    - **Расположение**: `socket-server/`.
    - **Назначение**: Обработка всех real-time соединений и событий. Это решение принято для масштабируемости и разделения ответственности.
    - **Масштабирование**: Интеграция с **Redis Adapter** (`@socket.io/redis-adapter`) позволяет горизонтально масштабировать сокет-серверы.

3.  **База данных и кэш**:
    - **БД**: **PostgreSQL** как основное хранилище данных.
    - **ORM**: **Prisma** для взаимодействия с базой данных.
    - **Кэш и Pub/Sub**: **Redis** используется для:
        - Кэширования часто запрашиваемых данных.
        - **Pub/Sub механизма** для связи между Next.js API и Socket.IO сервером. Например, когда API создает новый чат, оно публикует событие в Redis, а сокет-сервер, подписанный на него, уведомляет участников.

## Ключевые паттерны

- **Multi-file Prisma Schema**: Схема Prisma разделена на файлы по моделям (`User.prisma`, `Chat.prisma` и т.д.) и находится в директории `prisma/`. Это улучшает читаемость и модульность.
- **DTO (Data Transfer Object)**: Используются мапперы для преобразования моделей Prisma в `Client`-типы (например, `ClientChat`), чтобы отправлять на клиент только безопасные и необходимые данные.
- **RBAC (Role-Based Access Control)**: Роли (`user`, `admin`) определены в схеме `User` и используются в middleware (для API и Socket.IO) для защиты эндпоинтов и ограничения доступа.
- **Константы для событий**: Все имена событий Socket.IO вынесены в константы (`src/constants/socketEvents.ts`) для избежания ошибок и централизованного управления.
- **Централизованные импорты**: Модули и типы экспортируются через `index.ts` файлы в своих директориях для более чистых импортов.
- **Schema-Driven Development с Zod**: **Zod** является **единственным источником правды (Single Source of Truth)** для всех DTO и моделей данных.
    - **Схемы Zod** определяют структуру, валидацию и сообщения об ошибках для данных, передаваемых между клиентом и сервером. Они находятся в директории `src/schemas`.
    - **Типы TypeScript** для этих данных автоматически выводятся (infer) из схем Zod с помощью `z.infer<typeof schema>`. Это исключает рассинхронизацию между валидацией и статическими типами.
- **Строгая политика импортов (Barrel Files)**: Для поддержания чистоты кода и предсказуемости, все импорты из основных директорий (`components`, `constants`, `hooks`, `lib`, `schemas`, `types` и т.д.) должны осуществляться через их верхнеуровневый `index.ts` (barrel file). Это правило принудительно проверяется ESLint (`no-restricted-imports`).
- **Запрет утверждений типа (`as`)**: Утверждения типа (например, `foo as Bar`) запрещены в кодовой базе приложения (`src/**/*.ts(x)`). Этот паттерн может скрывать ошибки типизации и приводить к ошибкам в рантайме. Вместо него следует использовать более безопасные альтернативы:
    - **Сужение типов (Type Guards)**: Функции, которые проверяют тип и возвращают `value is Type`.
    - **Парсинг с помощью Zod**: Валидация внешних данных и получение строго типизированного объекта.
    - В крайнем случае, можно использовать `@ts-ignore` с комментарием, объясняющим причину.
    Исключения допускаются только в конфигурационных файлах. Правило принудительно проверяется ESLint (`no-restricted-syntax` для `TSAsExpression`).

## Архитектура Push-уведомлений (Web Push API)

Для доставки уведомлений, когда приложение неактивно, используется следующий механизм:

1.  **Service Worker**: Фоновый скрипт, генерируемый `next-pwa`, который слушает `push` события от Push-сервисов (Google, Apple, etc).
2.  **Подписка клиента**:
    - Клиент запрашивает у пользователя разрешение (`Notification.requestPermission()`).
    - При согласии браузер выдает объект `PushSubscription`.
    - Этот объект отправляется и сохраняется на бэкенде в специальной таблице `PushSubscription`, связанной с пользователем.
3.  **Отправка с бэкенда**:
    - Когда происходит событие (новое сообщение), `socket-server` или API находят подписки целевых пользователей.
    - С помощью библиотеки `web-push` бэкенд отправляет зашифрованное уведомление на endpoint из `PushSubscription`.
4.  **Отображение**: Service Worker на клиенте получает push-событие, расшифровывает payload и показывает системное уведомление через `self.registration.showNotification()`.

## Структура каталогов (Детализированная)

```
/chat-app
├── memory-bank/            # <--- Контекст, прогресс и правила проекта
├── prisma/                 # Prisma ORM
│   ├── schema/             # Мультифайловая схема Prisma (User.prisma, Chat.prisma и т.д.)
│   └── migrations/         # Миграции базы данных
├── public/                 # Статические ассеты (иконки для PWA)
├── socket-server/          # Выделенный Socket.IO сервер на TypeScript
│   ├── src/
│   │   ├── constants/      # Константы (имена каналов Redis)
│   │   ├── middlewares/    # Middleware для Socket.IO (authMiddleware.ts)
│   │   └── server.ts       # Основной файл сервера
│   └── (node_modules, tsconfig.json, package.json)
└── src/                    # Исходный код Next.js приложения
    ├── app/                # App Router: Роуты и страницы
    │   ├── api/            # API эндпоинты (Route Handlers)
    │   │   ├── auth/       # /api/auth/*: login, logout, me, register, confirm
    │   │   ├── chats/      # /api/chats/*: create, /, [chatId]
    │   │   └── messages/   # /api/messages/*: [messageId]
    │   ├── chat/[chatId]/  # Динамическая страница чата
    │   ├── admin/dashboard/# Страница админ-панели
    │   ├── (login, register, profile, confirm) # Другие страницы
    │   └── layout.tsx      # Главный layout приложения
    ├── components/         # Общие клиентские UI-компоненты
    │   ├── auth/           # Компоненты для аутентификации (LoginForm, RegisterForm)
    │   │   ├── common/     # Общие компоненты для форм (кнопки, ссылки)
    │   │   └── fields/     # Поля ввода (EmailField, PasswordField)
    │   ├── chat/           # Компоненты для чата (ChatContent, MessageInput)
    │   ├── layout/         # Компоненты макета (Sidebar, ErrorBoundary)
    │   │   └── sidebar/    # Внутренние компоненты сайдбара
    │   ├── message/        # Компонент MessageBubble
    │   ├── profile/        # Компонент UserProfileEditForm
    │   └── common/         # Общие компоненты (модальные окна)
    ├── constants/          # Константы приложения (apiRoutes, socketEvents, etc.)
    ├── contexts/           # React Contexts (AuthContext)
    ├── hooks/              # Кастомные React хуки (useAuth, useChat, etc.)
    ├── lib/                # Библиотеки и утилиты
    │   ├── api/            # Утилиты для API (apiErrorHandler)
    │   ├── auth/           # Логика сессий JWT
    │   ├── crypto/         # E2E-шифрование
    │   ├── fetch/          # Функции для получения данных
    │   ├── mappers/        # Мапперы (DTO) для преобразования Prisma моделей
    │   ├── prisma/         # Инициализация Prisma Client
    │   ├── redis/          # Инициализация Redis Client
    │   └── socket/         # Клиентская обертка для Socket.IO
    ├── providers/          # Провайдеры (AuthProvider)
    ├── schemas/            # Схемы Zod - единый источник правды для моделей данных
    ├── store/              # Стейт-менеджер (Zustand: chatStore)
    ├── types/              # Глобальные типы TypeScript, выводимые из схем Zod
    │   ├── auth/           # Типы для аутентификации (выведены из authSchemas)
    │   ├── chat/           # Типы для чатов (выведены из chatSchemas)
    │   ├── message/        # Типы для сообщений (выведены из messageSchemas)
    │   ├── sockets/        # Типы для событий Socket.IO
    │   └── user/           # Типы для пользователя
    └── utils/              # Вспомогательные утилиты
``` 